name: newapi.ai 自动签到
on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  checkin:
    permissions:
      id-token: write
      contents: read
    runs-on: windows-2025
    environment: production
    env:
      PYTHONIOENCODING: utf-8
    steps:
    - name: set beijing timezone
      uses: szenius/set-timezone@v2.0
      with:
        timezoneWindows: "China Standard Time"

    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: 缓存 UV 依赖
      uses: actions/cache@v4
      id: uv-cache
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: 安装依赖
      if: steps.uv-cache.outputs.cache-hit != 'true'
      run: |
        echo "缓存未命中，开始安装项目依赖..."
        uv sync
        echo "✅ 环境初始化完成"

    - name: 获取 Playwright 版本
      id: playwright-version
      run: |
        $version = uv run python -c "import importlib.metadata; print(importlib.metadata.version('playwright'))"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Playwright version: $version"

    - name: 缓存 Playwright 浏览器
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~\AppData\Local\ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: 安装 Playwright 浏览器
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: |
        echo "缓存未命中，开始安装 Playwright 浏览器..."
        uv run playwright install chromium --with-deps

    - name: 获取 Camoufox 版本
      id: camoufox-version
      run: |
        $version = uv run python -c "import importlib.metadata; print(importlib.metadata.version('camoufox'))"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Camoufox version: $version"

    - name: 缓存 Camoufox 浏览器
      uses: actions/cache@v4
      id: camoufox-cache
      with:
        path: ~\AppData\Local\camoufox
        key: ${{ runner.os }}-camoufox-${{ steps.camoufox-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-camoufox-

    - name: 安装 Camoufox 浏览器
      if: steps.camoufox-cache.outputs.cache-hit != 'true'
      run: |
        echo "缓存未命中，开始下载 Camoufox 浏览器..."
        uv run camoufox fetch
        echo "✅ Camoufox 浏览器安装完成"

    - name: 恢复登录状态缓存
      uses: actions/cache@v4
      with:
        path: |
          caches
        key: auth-caches-${{ github.sha }}
        restore-keys: |
          auth-caches-

    - name: 恢复余额历史缓存
      uses: actions/cache@v4
      with:
        path: |
          balance_hash.txt
        key: balance-hash-${{ github.sha }}
        restore-keys: |
          balance-hash-

    - name: 预热会话
      shell: pwsh
      run: |
        Write-Host "ℹ️ Warming up session with agentrouter.org..."
        try {
          $response = Invoke-WebRequest -Uri 'https://agentrouter.org/api/oauth/state' `
            -Method GET `
            -Headers @{
              'Accept' = 'application/json, text/plain, */*'
              'Accept-Language' = 'en,en-US;q=0.9,zh;q=0.8,en-CN;q=0.7,zh-CN;q=0.6'
              'Cache-Control' = 'no-store'
              'Connection' = 'keep-alive'
              'New-API-User' = '-1'
              'Pragma' = 'no-cache'
              'Referer' = 'https://agentrouter.org/login'
              'Sec-Fetch-Dest' = 'empty'
              'Sec-Fetch-Mode' = 'cors'
              'Sec-Fetch-Site' = 'same-origin'
              'User-Agent' = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36'
              'sec-ch-ua' = '"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"'
              'sec-ch-ua-mobile' = '?0'
              'sec-ch-ua-platform' = '"Windows"'
            } `
            -SessionVariable 'session' `
            -ErrorAction Stop

          Write-Host "✅ Session warmed up successfully"
          Write-Host "Response status: $($response.StatusCode)"
          Write-Host "Response body:"
          Write-Host $response.Content
        }
        catch {
          Write-Host "⚠️ Session warmup failed (non-critical): $($_.Exception.Message)"
          if ($_.Exception.Response) {
            Write-Host "Error response status: $($_.Exception.Response.StatusCode.value__)"
            try {
              $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
              $errorBody = $reader.ReadToEnd()
              Write-Host "Error response body: $errorBody"
            }
            catch {
              Write-Host "Could not read error response body"
            }
          }
        }

    - name: 执行签到
      env:
        ACCOUNTS: ${{ secrets.ACCOUNTS }}
        PROVIDERS: ${{ secrets.PROVIDERS }}
        DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
      run: |
        uv run python -u main.py

    - name: 上传截图
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_number }}
        path: screenshots/
        if-no-files-found: ignore
        retention-days: 7

    - name: 执行结果
      if: always()
      run: |
        echo "签到任务执行完成"
        echo "时间: $(Get-Date)"
